<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanjevani WebSocket Tester</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            grid-column: 1 / -1;
        }
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
        }
        textarea {
            min-height: 80px;
            font-size: 11px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .disconnect {
            background: #e74c3c;
        }
        .disconnect:hover {
            background: #c0392b;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .connected {
            background: #2ecc71;
            color: white;
        }
        .disconnected {
            background: #e74c3c;
            color: white;
        }
        .messages {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-left: 4px solid #3498db;
            border-radius: 3px;
        }
        .message.incoming {
            border-left-color: #2ecc71;
        }
        .message.error {
            border-left-color: #e74c3c;
            background: #fadbd8;
        }
        .timestamp {
            color: #7f8c8d;
            font-size: 10px;
        }
        .info-box {
            background: #d5f4e6;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <h1>üè• Sanjevani WebSocket Tester (Auto-Authentication)</h1>
    
    <div class="container">
        <!-- Customer Panel -->
        <div class="panel">
            <h2>üë§ Customer Panel</h2>
            <div class="input-group">
                <label>JWT Token (Customer):</label>
                <textarea id="customerToken" placeholder="Paste customer JWT token from test_tokens.json"></textarea>
            </div>
            <div>
                <button onclick="connectCustomer()" id="connectCustomerBtn">Connect</button>
                <button onclick="disconnectCustomer()" id="disconnectCustomerBtn" class="disconnect" disabled>Disconnect</button>
            </div>
            <div id="customerStatus" class="status disconnected">Disconnected</div>
            
            <h3>üì• Received Messages:</h3>
            <div id="customerMessages" class="messages">
                <p style="color: #95a5a6;">Waiting for messages...</p>
            </div>
        </div>
        
        <!-- Pharmacy Panel -->
        <div class="panel">
            <h2>üè• Pharmacy Panel</h2>
            <div class="input-group">
                <label>JWT Token (Pharmacy):</label>
                <textarea id="pharmacyToken" placeholder="Paste pharmacy JWT token from test_tokens.json"></textarea>
            </div>
            <div>
                <button onclick="connectPharmacy()" id="connectPharmacyBtn">Connect</button>
                <button onclick="disconnectPharmacy()" id="disconnectPharmacyBtn" class="disconnect" disabled>Disconnect</button>
            </div>
            <div id="pharmacyStatus" class="status disconnected">Disconnected</div>
            
            <h3>üì• Received Messages:</h3>
            <div id="pharmacyMessages" class="messages">
                <p style="color: #95a5a6;">Waiting for messages...</p>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="panel" style="grid-column: 1 / -1;">
            <h2>üìã Testing Instructions</h2>
            <div class="info-box">
                <h3>‚ú® New: Automatic Authentication!</h3>
                <p><strong>No need to manually enter user/pharmacy IDs!</strong> The system automatically:</p>
                <ul>
                    <li>Identifies the user from JWT token</li>
                    <li>Connects customers to their personal channel</li>
                    <li>Connects pharmacies to their pharmacy channel with location info</li>
                    <li>Validates user roles (customers can't connect as pharmacy and vice versa)</li>
                </ul>
            </div>
            
            <h3>Setup:</h3>
            <ol>
                <li><strong>Start Redis:</strong> <code>docker run -d -p 6379:6379 redis:alpine</code></li>
                <li><strong>Start Django:</strong> <code>python manage.py runserver</code></li>
                <li><strong>Get Tokens:</strong> Open <code>test_tokens.json</code> and copy the JWT tokens</li>
            </ol>
            
            <h3>Testing Flow:</h3>
            <ol>
                <li><strong>Paste Tokens:</strong> Copy tokens from test_tokens.json into the text areas above</li>
                <li><strong>Connect:</strong> Click Connect buttons - authentication is automatic!</li>
                <li><strong>Create Request:</strong> Use Postman/curl to create medicine request with custom radius</li>
                <li><strong>Watch Broadcast:</strong> Pharmacy panel receives notification automatically</li>
                <li><strong>Pharmacy Responds:</strong> First to accept wins, others get notified</li>
            </ol>
            
            <h3>New WebSocket URLs:</h3>
            <pre>
# Customer WebSocket (auto-detects user from token)
ws://localhost:8000/ws/customer/?token=YOUR_JWT_TOKEN

# Pharmacy WebSocket (auto-detects pharmacy from token)
ws://localhost:8000/ws/pharmacy/?token=YOUR_JWT_TOKEN
            </pre>
            
            <h3>Create Medicine Request with Custom Radius:</h3>
            <pre>
# PowerShell
$token = (Get-Content test_tokens.json | ConvertFrom-Json).customer.token

curl.exe -X POST http://localhost:8000/medicine/request/ `
  -H "Authorization: Bearer $token" `
  -F "patient_lat=27.7172" `
  -F "patient_lng=85.3240" `
  -F "radius_km=10.0" `  # User can choose any radius!
  -F "quantity=10" `
  -F "image=@prescription.jpg"
            </pre>
            
            <h3>Key Features:</h3>
            <ul>
                <li>‚úÖ <strong>Auto-authentication:</strong> No manual user/pharmacy IDs</li>
                <li>‚úÖ <strong>Flexible radius:</strong> Customer chooses search radius (1-50 km)</li>
                <li>‚úÖ <strong>Role validation:</strong> Only customers can be customers, only pharmacies can be pharmacies</li>
                <li>‚úÖ <strong>Location-based:</strong> Only pharmacies within radius receive broadcast</li>
            </ul>
        </div>
    </div>
    
    <script>
        let customerWs = null;
        let pharmacyWs = null;
        
        function connectCustomer() {
            const token = document.getElementById('customerToken').value.trim();
            if (!token) {
                alert('Please paste the customer JWT token');
                return;
            }
            
            // Connect with token as query parameter - server auto-detects user
            customerWs = new WebSocket(`ws://localhost:8000/ws/customer/?token=${token}`);
            
            customerWs.onopen = () => {
                updateStatus('customer', 'connected');
                addMessage('customer', 'Connecting with auto-authentication...', 'system');
                document.getElementById('connectCustomerBtn').disabled = true;
                document.getElementById('disconnectCustomerBtn').disabled = false;
            };
            
            customerWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                // Handle connection confirmation
                if (data.type === 'connection') {
                    addMessage('customer', `‚úÖ Authenticated as: ${data.user_name} (ID: ${data.user_id})`, 'system');
                } else {
                    addMessage('customer', JSON.stringify(data, null, 2), 'incoming');
                }
            };
            
            customerWs.onerror = (error) => {
                addMessage('customer', 'WebSocket error - check console', 'error');
                console.error(error);
            };
            
            customerWs.onclose = (event) => {
                updateStatus('customer', 'disconnected');
                if (event.code === 4001) {
                    addMessage('customer', '‚ùå Authentication failed - invalid token', 'error');
                } else if (event.code === 4003) {
                    addMessage('customer', '‚ùå Wrong role - this token is not for a customer', 'error');
                } else {
                    addMessage('customer', 'Disconnected from server', 'system');
                }
                document.getElementById('connectCustomerBtn').disabled = false;
                document.getElementById('disconnectCustomerBtn').disabled = true;
            };
        }
        
        function connectPharmacy() {
            const token = document.getElementById('pharmacyToken').value.trim();
            if (!token) {
                alert('Please paste the pharmacy JWT token');
                return;
            }
            
            // Connect with token as query parameter - server auto-detects pharmacy
            pharmacyWs = new WebSocket(`ws://localhost:8000/ws/pharmacy/?token=${token}`);
            
            pharmacyWs.onopen = () => {
                updateStatus('pharmacy', 'connected');
                addMessage('pharmacy', 'Connecting with auto-authentication...', 'system');
                document.getElementById('connectPharmacyBtn').disabled = true;
                document.getElementById('disconnectPharmacyBtn').disabled = false;
            };
            
            pharmacyWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                // Handle connection confirmation
                if (data.type === 'connection') {
                    addMessage('pharmacy', 
                        `‚úÖ Authenticated as: ${data.pharmacy_name}\n` +
                        `   Pharmacy ID: ${data.pharmacy_id}\n` +
                        `   Location: (${data.location.lat}, ${data.location.lng})`,
                        'system');
                } else {
                    addMessage('pharmacy', JSON.stringify(data, null, 2), 'incoming');
                }
            };
            
            pharmacyWs.onerror = (error) => {
                addMessage('pharmacy', 'WebSocket error - check console', 'error');
                console.error(error);
            };
            
            pharmacyWs.onclose = (event) => {
                updateStatus('pharmacy', 'disconnected');
                if (event.code === 4001) {
                    addMessage('pharmacy', '‚ùå Authentication failed - invalid token', 'error');
                } else if (event.code === 4003) {
                    addMessage('pharmacy', '‚ùå Wrong role - this token is not for a pharmacy', 'error');
                } else if (event.code === 4004) {
                    addMessage('pharmacy', '‚ùå No pharmacy found for this user', 'error');
                } else {
                    addMessage('pharmacy', 'Disconnected from server', 'system');
                }
                document.getElementById('connectPharmacyBtn').disabled = false;
                document.getElementById('disconnectPharmacyBtn').disabled = true;
            };
        }
        
        function disconnectCustomer() {
            if (customerWs) {
                customerWs.close();
            }
        }
        
        function disconnectPharmacy() {
            if (pharmacyWs) {
                pharmacyWs.close();
            }
        }
        
        function updateStatus(panel, status) {
            const element = document.getElementById(`${panel}Status`);
            element.className = `status ${status}`;
            element.textContent = status === 'connected' ? 'Connected ‚úì' : 'Disconnected';
        }
        
        function addMessage(panel, message, type = 'incoming') {
            const container = document.getElementById(`${panel}Messages`);
            const timestamp = new Date().toLocaleTimeString();
            
            // Clear placeholder
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <pre style="margin: 5px 0; white-space: pre-wrap;">${message}</pre>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Auto-load tokens from clipboard or localStorage
        window.addEventListener('load', () => {
            const savedCustomerToken = localStorage.getItem('customerToken');
            const savedPharmacyToken = localStorage.getItem('pharmacyToken');
            
            if (savedCustomerToken) {
                document.getElementById('customerToken').value = savedCustomerToken;
            }
            if (savedPharmacyToken) {
                document.getElementById('pharmacyToken').value = savedPharmacyToken;
            }
        });
        
        // Save tokens to localStorage when changed
        document.getElementById('customerToken').addEventListener('blur', (e) => {
            localStorage.setItem('customerToken', e.target.value);
        });
        document.getElementById('pharmacyToken').addEventListener('blur', (e) => {
            localStorage.setItem('pharmacyToken', e.target.value);
        });
    </script>
</body>
</html>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            grid-column: 1 / -1;
        }
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .disconnect {
            background: #e74c3c;
        }
        .disconnect:hover {
            background: #c0392b;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .connected {
            background: #2ecc71;
            color: white;
        }
        .disconnected {
            background: #e74c3c;
            color: white;
        }
        .messages {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-left: 4px solid #3498db;
            border-radius: 3px;
        }
        .message.incoming {
            border-left-color: #2ecc71;
        }
        .message.outgoing {
            border-left-color: #f39c12;
        }
        .message.error {
            border-left-color: #e74c3c;
            background: #fadbd8;
        }
        .timestamp {
            color: #7f8c8d;
            font-size: 10px;
        }
        .info-box {
            background: #d5f4e6;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üè• Sanjevani WebSocket Tester</h1>
    
    <div class="container">
        <!-- Customer Panel -->
        <div class="panel">
            <h2>üë§ Customer Panel</h2>
            <div class="input-group">
                <label>Customer ID:</label>
                <input type="text" id="customerId" placeholder="Enter customer user ID (e.g., 7)">
            </div>
            <div>
                <button onclick="connectCustomer()" id="connectCustomerBtn">Connect</button>
                <button onclick="disconnectCustomer()" id="disconnectCustomerBtn" class="disconnect" disabled>Disconnect</button>
            </div>
            <div id="customerStatus" class="status disconnected">Disconnected</div>
            
            <h3>üì• Received Messages:</h3>
            <div id="customerMessages" class="messages">
                <p style="color: #95a5a6;">Waiting for messages...</p>
            </div>
        </div>
        
        <!-- Pharmacy Panel -->
        <div class="panel">
            <h2>üè• Pharmacy Panel</h2>
            <div class="input-group">
                <label>Pharmacy ID:</label>
                <input type="text" id="pharmacyId" placeholder="Enter pharmacy ID (e.g., 3)">
            </div>
            <div>
                <button onclick="connectPharmacy()" id="connectPharmacyBtn">Connect</button>
                <button onclick="disconnectPharmacy()" id="disconnectPharmacyBtn" class="disconnect" disabled>Disconnect</button>
            </div>
            <div id="pharmacyStatus" class="status disconnected">Disconnected</div>
            
            <h3>üì• Received Messages:</h3>
            <div id="pharmacyMessages" class="messages">
                <p style="color: #95a5a6;">Waiting for messages...</p>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="panel" style="grid-column: 1 / -1;">
            <h2>üìã Testing Instructions</h2>
            <div class="info-box">
                <h3>Setup:</h3>
                <ol>
                    <li><strong>Start Redis:</strong> <code>docker run -d -p 6379:6379 redis:alpine</code></li>
                    <li><strong>Start Django:</strong> <code>python manage.py runserver</code></li>
                    <li><strong>Get IDs:</strong> Check test_tokens.json for user IDs or query database</li>
                </ol>
            </div>
            
            <h3>Testing Flow:</h3>
            <ol>
                <li><strong>Connect WebSockets:</strong> Enter Customer ID (e.g., 7) and Pharmacy ID (e.g., 3) and click Connect</li>
                <li><strong>Create Medicine Request:</strong> Use Postman/curl to POST to <code>/medicine/request/</code> with customer token</li>
                <li><strong>Watch Pharmacy Panel:</strong> Should receive <code>new_request</code> notification</li>
                <li><strong>Pharmacy Responds:</strong> POST to <code>/medicine/response/</code> with pharmacy token</li>
                <li><strong>Watch Customer Panel:</strong> Should receive <code>pharmacy_response</code> notification</li>
                <li><strong>Watch Other Pharmacies:</strong> Should receive <code>request_taken</code> notification</li>
            </ol>
            
            <h3>Sample curl commands:</h3>
            <pre>
# Get your tokens from test_tokens.json
cat test_tokens.json

# Create Medicine Request (Customer)
curl -X POST http://localhost:8000/medicine/request/ \
  -H "Authorization: Bearer YOUR_CUSTOMER_TOKEN" \
  -F "patient_lat=27.7172" \
  -F "patient_lng=85.3240" \
  -F "radius_km=5.0" \
  -F "quantity=10" \
  -F "image=@prescription.jpg"

# Pharmacy Response (Accept)
curl -X POST http://localhost:8000/medicine/response/ \
  -H "Authorization: Bearer YOUR_PHARMACY_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "request_id": 1,
    "response_type": "ACCEPTED",
    "text_message": "We have it in stock!"
  }'
            </pre>
        </div>
    </div>
    
    <script>
        let customerWs = null;
        let pharmacyWs = null;
        
        function connectCustomer() {
            const customerId = document.getElementById('customerId').value;
            if (!customerId) {
                alert('Please enter Customer ID');
                return;
            }
            
            customerWs = new WebSocket(`ws://localhost:8000/ws/medicine/user/${customerId}/`);
            
            customerWs.onopen = () => {
                updateStatus('customer', 'connected');
                addMessage('customer', 'Connected to server', 'system');
                document.getElementById('connectCustomerBtn').disabled = true;
                document.getElementById('disconnectCustomerBtn').disabled = false;
            };
            
            customerWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addMessage('customer', JSON.stringify(data, null, 2), 'incoming');
            };
            
            customerWs.onerror = (error) => {
                addMessage('customer', 'WebSocket error: ' + error, 'error');
            };
            
            customerWs.onclose = () => {
                updateStatus('customer', 'disconnected');
                addMessage('customer', 'Disconnected from server', 'system');
                document.getElementById('connectCustomerBtn').disabled = false;
                document.getElementById('disconnectCustomerBtn').disabled = true;
            };
        }
        
        function connectPharmacy() {
            const pharmacyId = document.getElementById('pharmacyId').value;
            if (!pharmacyId) {
                alert('Please enter Pharmacy ID');
                return;
            }
            
            pharmacyWs = new WebSocket(`ws://localhost:8000/ws/medicine/pharmacy/${pharmacyId}/`);
            
            pharmacyWs.onopen = () => {
                updateStatus('pharmacy', 'connected');
                addMessage('pharmacy', 'Connected to server', 'system');
                document.getElementById('connectPharmacyBtn').disabled = true;
                document.getElementById('disconnectPharmacyBtn').disabled = false;
            };
            
            pharmacyWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addMessage('pharmacy', JSON.stringify(data, null, 2), 'incoming');
            };
            
            pharmacyWs.onerror = (error) => {
                addMessage('pharmacy', 'WebSocket error: ' + error, 'error');
            };
            
            pharmacyWs.onclose = () => {
                updateStatus('pharmacy', 'disconnected');
                addMessage('pharmacy', 'Disconnected from server', 'system');
                document.getElementById('connectPharmacyBtn').disabled = false;
                document.getElementById('disconnectPharmacyBtn').disabled = true;
            };
        }
        
        function disconnectCustomer() {
            if (customerWs) {
                customerWs.close();
            }
        }
        
        function disconnectPharmacy() {
            if (pharmacyWs) {
                pharmacyWs.close();
            }
        }
        
        function updateStatus(panel, status) {
            const element = document.getElementById(`${panel}Status`);
            element.className = `status ${status}`;
            element.textContent = status === 'connected' ? 'Connected ‚úì' : 'Disconnected';
        }
        
        function addMessage(panel, message, type = 'incoming') {
            const container = document.getElementById(`${panel}Messages`);
            const timestamp = new Date().toLocaleTimeString();
            
            // Clear placeholder
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <pre style="margin: 5px 0; white-space: pre-wrap;">${message}</pre>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
